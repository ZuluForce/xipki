<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog file:dbchangelog-3.0.xsd" logicalFilePath="ca-init.xml">
	<!-- CA configuration :: create table -->
	<changeSet author="xipki" id="1">
		<!-- table cmpcontrol -->
		<createTable tableName="CMPCONTROL">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="REQUIRE_CONFIRM_CERT" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="MESSAGE_TIME_BIAS" remarks="seconds" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="CONFIRM_WAIT_TIME" remarks="seconds" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="SEND_CA_CERT" type="INT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<!-- table responder -->
		<createTable tableName="RESPONDER">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="TYPE" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column name="CONF" type="VARCHAR(4000)"/>
			<column name="CERT" type="VARCHAR(2000)"/>
		</createTable>
		<!-- table environment -->
		<createTable tableName="ENVIRONMENT">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="VALUE" type="VARCHAR(200)"/>
		</createTable>
		<!-- table crlsigner -->
		<createTable tableName="CRLSIGNER">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="SIGNER_TYPE" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column name="SIGNER_CONF" type="VARCHAR(4000)"/>
			<column name="SIGNER_CERT" type="VARCHAR(2000)"/>
			<column name="PERIOD" remarks="minutes. 0 indicates no CRL will be generated automatically." type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="OVERLAP" remarks="minutes" type="INT">
				<constraints nullable="false"/>
			</column>
			<column defaultValueNumeric="0" name="INCLUDE_CERTS_IN_CRL" type="INT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<!-- table requestor -->
		<createTable tableName="REQUESTOR">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="CERT" type="VARCHAR(2000)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<!-- table publisher -->
		<createTable tableName="PUBLISHER">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="TYPE" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column name="CONF" type="VARCHAR(5000)"/>
		</createTable>
		<!-- table certprofile -->
		<createTable tableName="CERTPROFILE">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="TYPE" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column name="CONF" remarks="profile data, depends on the type" type="VARCHAR(4000)"/>
		</createTable>
		<!-- table ca -->
		<createTable tableName="CA">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="NEXT_SERIAL" type="INT(10)"/>
			<column name="STATUS" remarks="valid values: pending, enabled, disabled" type="VARCHAR(10)">
				<constraints nullable="false"/>
			</column>
			<column name="SUBJECT" type="VARCHAR(200)">
				<constraints nullable="false"/>
			</column>
			<column name="CRL_URIS" type="VARCHAR(100)"/>
			<column name="OCSP_URIS" type="VARCHAR(100)"/>
			<column name="MAX_VALIDITY" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="CERT" type="VARCHAR(2000)">
				<constraints nullable="false"/>
			</column>
			<column name="SIGNER_TYPE" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column name="SIGNER_CONF" type="VARCHAR(4000)">
				<constraints nullable="false"/>
			</column>
			<column name="CRLSIGNER_NAME" type="VARCHAR(45)"/>
			<column defaultValueNumeric="1" name="ALLOW_DUPLICATE_KEY" type="INT">
				<constraints nullable="false"/>
			</column>
			<column defaultValueNumeric="1" name="ALLOW_DUPLICATE_SUBJECT" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="PERMISSIONS" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column defaultValueNumeric="30" name="NUM_CRLS" type="INT">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<!-- table caalias -->
		<createTable tableName="CAALIAS">
			<column name="NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="CA_NAME" type="VARCHAR(45)">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<!-- table ca_has_requestor -->
		<createTable tableName="CA_HAS_REQUESTOR">
			<column name="CA_NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="REQUESTOR_NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="RA" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="PERMISSIONS" type="VARCHAR(100)"/>
			<column name="PROFILES" type="VARCHAR(200)"/>
		</createTable>
		<!-- table ca_has_publisher -->
		<createTable tableName="CA_HAS_PUBLISHER">
			<column name="CA_NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="PUBLISHER_NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
		</createTable>
		<!-- table ca_has_profile -->
		<createTable tableName="CA_HAS_CERTPROFILE">
			<column name="CA_NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="CERTPROFILE_NAME" type="VARCHAR(45)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	<!-- CertStore :: create table -->
	<changeSet author="xipki" id="2">
		<!-- table cainfo -->
		<createTable tableName="CAINFO">
			<column name="ID" type="INT(10)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="SUBJECT" type="VARCHAR(200)">
				<constraints nullable="false"/>
			</column>
			<column name="CERT" type="VARCHAR(2000)">
				<constraints nullable="false"/>
			</column>
			<column name="SHA1_FP_CERT" type="CHAR(40)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<!-- table requestorinfo -->
		<createTable tableName="REQUESTORINFO">
			<column name="ID" type="INT(10)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="SUBJECT" type="VARCHAR(200)">
				<constraints nullable="false"/>
			</column>
			<column name="CERT" type="VARCHAR(2000)"/>
			<column name="SHA1_FP_CERT" type="CHAR(40)"/>
		</createTable>
		<!-- table user -->
		<createTable tableName="USER">
			<column name="ID" type="INT(10)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="NAME" type="VARCHAR(200)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<!-- table certprofileinfo -->
		<createTable tableName="CERTPROFILEINFO">
			<column name="ID" type="INT(10)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="NAME" type="VARCHAR(45)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<!-- table crl -->
		<createTable tableName="CRL">
			<column autoIncrement="true" name="ID" type="INT(10)">
				<constraints primaryKey="true" unique="true"/>
			</column>
			<column name="CAINFO_ID" type="INT(10)">
				<constraints nullable="false"/>
			</column>
			<column name="CRL_NUMBER" type="INT(10)">
				<constraints nullable="false"/>
			</column>
			<column name="THISUPDATE" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="NEXtUPDATE" type="INT"/>
			<column name="CRL" type="LONGBLOB">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addUniqueConstraint tableName="CRL" columnNames="CAINFO_ID, CRL_NUMBER" constraintName="CONST_CA_CRLNUMBER"/>

		<!-- table cert -->
		<createTable tableName="CERT">
			<column name="ID" type="INT(10)">
				<constraints primaryKey="true" unique="true" nullable="false"/>
			</column>
			<column name="CAINFO_ID" type="INT(10)">
				<constraints nullable="false"/>
			</column>
			<column name="SERIAL" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="CERTPROFILEINFO_ID" type="INT(10)">
				<constraints nullable="false"/>
			</column>
			<column name="REQUESTORINFO_ID" type="INT(10)"/>
			<column name="SUBJECT" type="VARCHAR(200)">
				<constraints nullable="false"/>
			</column>
			<column name="LAST_UPDATE" remarks="seconds since January 1, 1970, 00:00:00 GMT" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="NOTBEFORE" remarks="seconds since January 1, 1970, 00:00:00 GMT" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="NOTAFTER" remarks="seconds since January 1, 1970, 00:00:00 GMT" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="REVOCATED" type="INT">
				<constraints nullable="false"/>
			</column>
			<column name="REV_REASON" type="INT"/>
			<column name="REV_TIME" remarks="seconds since January 1, 1970, 00:00:00 GMT" type="INT"/>
			<column name="REV_INVALIDITY_TIME" remarks="seconds since January 1, 1970, 00:00:00 GMT" type="INT"/>
			<column name="USER_ID" type="INT(10)"/>
			<column name="SHA1_FP_PK" type="CHAR(40)">
				<constraints nullable="false"/>
			</column>
			<column name="SHA1_FP_SUBJECT" type="CHAR(40)">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addUniqueConstraint tableName="CERT" columnNames="CAINFO_ID, SERIAL" constraintName="CONST_CA_SERIAL"/>

		<createIndex tableName="CERT" unique="false" indexName="IDX_FP_PK">
			<column name="SHA1_FP_PK"/>
		</createIndex>

		<createIndex tableName="CERT" unique="false" indexName="IDX_FP_SUBJECT">
			<column name="SHA1_FP_SUBJECT"/>
		</createIndex>

		<!-- table rawcert -->
		<createTable tableName="RAWCERT">
			<column name="CERT_ID" type="INT(10)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="SHA1_FP" type="VARCHAR(40)">
				<constraints nullable="false"/>
			</column>
			<column name="CERT" remarks="Base64 encoded certificate" type="VARCHAR(2000)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<!-- CA Configuration :: foreign key -->
	<changeSet author="xipki" id="3">
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CRLSIGNER_NAME" baseTableName="CA" 
			constraintName="FK_CA_CRLSIGNER1"
			referencedColumnNames="NAME" referencedTableName="CRLSIGNER"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CA_NAME" baseTableName="CAALIAS"
			constraintName="FK_SERVLETNAME_CA1"
			referencedColumnNames="NAME" referencedTableName="CA"/>
			
		<!-- ca_ha_requestor -->
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="REQUESTOR_NAME" baseTableName="CA_HAS_REQUESTOR"
			constraintName="FK_CA_HAS_REQUESTOR_REQUESTOR1"
			referencedColumnNames="NAME" referencedTableName="REQUESTOR"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CA_NAME" baseTableName="CA_HAS_REQUESTOR"
			constraintName="FK_CA_HAS_REQUESTOR1_CA1"
			referencedColumnNames="NAME" referencedTableName="CA"/>

		<!-- ca_has_publisher -->
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="PUBLISHER_NAME" baseTableName="CA_HAS_PUBLISHER"
			constraintName="FK_CA_HAS_PUBLISHER_PUBLISHER1"
			referencedColumnNames="NAME" referencedTableName="PUBLISHER"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
		 	onDelete="CASCADE" onUpdate="NO ACTION"
		 	baseColumnNames="CA_NAME" baseTableName="CA_HAS_PUBLISHER"
		 	constraintName="FK_CA_HAS_PUBLISHER_CA1"
		 	referencedColumnNames="NAME" referencedTableName="CA"/>
		 	
		<!-- ca_has_certprofile -->
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CERTPROFILE_NAME" baseTableName="CA_HAS_CERTPROFILE"
			constraintName="FK_CA_HAS_CERTPROFILE_CERTPROFILE1"
			referencedColumnNames="NAME" referencedTableName="CERTPROFILE"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CA_NAME" baseTableName="CA_HAS_CERTPROFILE"
			constraintName="FK_CA_HAS_CERTPROFILE_CA1"
			referencedColumnNames="NAME" referencedTableName="CA"/>
	</changeSet>
	<!-- CertStore :: foreigen key -->
	<changeSet author="xipki" id="4">
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CAINFO_ID" baseTableName="CRL"
			constraintName="FK_CRL_CAINFO1"
			referencedColumnNames="ID" referencedTableName="CAINFO"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CAINFO_ID" baseTableName="CERT"
			constraintName="FK_CERT_CAINFO1"
			referencedColumnNames="ID" referencedTableName="CAINFO"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="REQUESTORINFO_ID" baseTableName="CERT"
			constraintName="FK_CERT_REQUESTORINFO1"
			referencedColumnNames="ID" referencedTableName="REQUESTORINFO"/>

		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="USER_ID" baseTableName="CERT"
			constraintName="FK_CERT_USER1"
			referencedColumnNames="ID" referencedTableName="USER"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CERTPROFILEINFO_ID" baseTableName="CERT"
			constraintName="FK_CERT_CERTPROFILEINFO1"
			referencedColumnNames="ID" referencedTableName="CERTPROFILEINFO"/>
			
		<addForeignKeyConstraint deferrable="false" initiallyDeferred="false"
			onDelete="CASCADE" onUpdate="NO ACTION"
			baseColumnNames="CERT_ID" baseTableName="RAWCERT"
			constraintName="FK_RAWCERT_CERT1"
			referencedColumnNames="ID" referencedTableName="CERT"/>
	</changeSet>
</databaseChangeLog>
